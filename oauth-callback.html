<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitter Auth - Howl Voice Chat</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #000;
      color: #fff;
    }
    .container {
      text-align: center;
      padding: 40px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(29, 155, 240, 0.2);
      border-top-color: #1d9bf0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    h2 { margin: 0 0 10px; }
    p { color: rgba(255, 255, 255, 0.6); }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner"></div>
    <h2>Connecting to Twitter...</h2>
    <p>Please wait while we complete authentication</p>
  </div>

  <script>
    (async () => {
      try {
        // Get authorization code from URL
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        
        if (!code) {
          throw new Error('No authorization code received');
        }

        // Get stored code verifier
        const codeVerifier = localStorage.getItem('howl_code_verifier');
        const storedState = localStorage.getItem('howl_auth_state');
        
        if (state !== storedState) {
          throw new Error('State mismatch');
        }

        // Exchange code for access token
        const tokenResponse = await fetch('https://api.twitter.com/2/oauth2/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            code,
            grant_type: 'authorization_code',
            client_id: 'c3phaGVxdlFtZHUzWllwSGhUT16MTpjaQ',
            redirect_uri: 'https://trenchecho.com/oauth-callback.html',
            code_verifier: codeVerifier
          })
        });

        if (!tokenResponse.ok) {
          throw new Error('Token exchange failed');
        }

        const tokenData = await tokenResponse.json();
        const accessToken = tokenData.access_token;

        // Get user profile
        const userResponse = await fetch('https://api.twitter.com/2/users/me?user.fields=profile_image_url', {
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });

        if (!userResponse.ok) {
          throw new Error('Failed to get user profile');
        }

        const userData = await userResponse.json();
        
        // Clean up
        localStorage.removeItem('howl_code_verifier');
        localStorage.removeItem('howl_auth_state');

        // Send data back to parent window
        if (window.opener) {
          window.opener.postMessage({
            type: 'twitter-oauth-success',
            name: userData.data.name,
            username: userData.data.username,
            profile_image_url: userData.data.profile_image_url
          }, '*');
          
          setTimeout(() => window.close(), 500);
        }

      } catch (error) {
        console.error('OAuth error:', error);
        
        if (window.opener) {
          window.opener.postMessage({
            type: 'twitter-oauth-error',
            error: error.message
          }, '*');
        }
        
        document.querySelector('.container').innerHTML = `
          <h2>Authentication Failed</h2>
          <p>${error.message}</p>
          <p>You can close this window and try again.</p>
        `;
      }
    })();
  </script>
</body>
</html>
